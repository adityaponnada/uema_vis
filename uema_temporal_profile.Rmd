---
title: "Explore uEMA trajectories"
author: "Aditya Ponnada"
date: "4/12/2021"
output: html_document
---

# Include libraries
```{r}
library(lubridate)
library(dplyr)
library(plyr)
library(reshape2)
library(plotly)
library(ggplot2)
library(shiny)
library(shinycssloaders)
library(shinydashboard)
library(psych)
options(digits = 2)

```

# Read the combined uEMA response file

Get the root file location and construct user paths from it
```{r}
# pre_process_root_path <- "D:/Intermediate_TIME_files/intermediate_file"
pre_process_root_path <- "D:/new_data_pre_processed/watch"

# file_pattern <- paste0(pre_process_root_path, '/*/*/watch_promptresponse_clean_*.csv')
file_pattern <- paste0(pre_process_root_path, '/*/watch_promptresponse_clean_*.csv')

```


## Combine all the prompt response files for the participant
```{r}
pattern_files_found <- Sys.glob(file_pattern)

combined_uema_file <- do.call(rbind, lapply(pattern_files_found, read.csv))
```

## Read the combined daily report file
```{r}

combined_report_file = paste0('D:/new_data_pre_processed', '/combined_report_N70.csv')
combined_report_df <- read.csv(combined_report_file, header = TRUE, sep = ',')

```

## Convert the prompt time to date time column
For uEMA combined file

```{r}
combined_uema_file <- subset(combined_uema_file, combined_uema_file$Answer_Status == "Completed" | combined_uema_file$Answer_Status == "CompletedThenDismissed" )
combined_uema_file <- subset(combined_uema_file, combined_uema_file$Question_X_Answer_Text != "-NOT_ANS-")

## if unanswered then set prompt time as the completion time?
# combined_uema_file$Prompt_Time_only <- substr(combined_uema_file$Initial_Prompt_Local_Time, 12, 19)
# combined_uema_file$Question_Set_Completion_Local_Time[combined_uema_file$Question_X_Answer_Text == '-NOT_ANS-'] <- combined_uema_file$Prompt_Time_only


combined_uema_file$date_time <- paste0(combined_uema_file$Initial_Prompt_Date, " ", combined_uema_file$Question_Set_Completion_Local_Time)

combined_uema_file$date_timestamp <- as.POSIXct(combined_uema_file$date_time, format="%Y-%m-%d %H:%M:%OS")
```

## Filter dates before june 1 temporarily
For uEMA combined file

```{r}
filter_date <- as.POSIXct("2020-06-01 00:00:00.000", format="%Y-%m-%d %H:%M:%OS")

combined_uema_file <- subset(combined_uema_file, combined_uema_file$date_timestamp >= filter_date)

```

## Remove trivia and val questions
uEMA combined file

```{r}
combined_uema_file <- combined_uema_file[!grepl("Val_", combined_uema_file$Question_X_ID),]
combined_uema_file <- combined_uema_file[!grepl("trivia_", combined_uema_file$Question_X_ID),]
combined_uema_file <- combined_uema_file[!grepl("trait_", combined_uema_file$Question_X_ID),]
combined_uema_file <- combined_uema_file[!grepl("soc_", combined_uema_file$Question_X_ID),]
```


## Score answers
uEMA combined file

```{r}
combined_uema_file$Answer_score[combined_uema_file$Question_X_Answer_Text == "Yes"] <- 3
combined_uema_file$Answer_score[combined_uema_file$Question_X_Answer_Text == "Sort of"] <- 2
combined_uema_file$Answer_score[combined_uema_file$Question_X_Answer_Text == "No"] <- 1
# combined_uema_file$Answer_score[combined_uema_file$Question_X_Answer_Text == "-NOT_ANS-"] <- 0

```


## Create a Q_D column without the numbers
uEMA combined file

```{r}
combined_uema_file$Q_ID <- strsplit(combined_uema_file$Question_X_ID, "[[:digit:]]", perl = TRUE)
combined_uema_file$Q_ID <- lapply(combined_uema_file$Q_ID, '[[', 1)
combined_uema_file$Q_ID <- as.character(combined_uema_file$Q_ID)
combined_uema_file$Q_ID <- gsub(".{1}$", "", combined_uema_file$Q_ID)
```



## Convert sleep wake times in daily report to datetime
Combined daily report file

```{r}

combined_report_df$current_wake_time <- as.POSIXct(combined_report_df$current_wake_time, format="%Y-%m-%d %H:%M:%S")
combined_report_df$current_sleep_time <- as.POSIXct(combined_report_df$current_sleep_time, format="%Y-%m-%d %H:%M:%S")

```

## create a subset for participant
uEMA combined file

```{r}

get_uEMA_pid_df <- function(df, p_id){
  pid_df <- subset(df, df$Participant_ID == p_id)
  return(pid_df)
}

```

Combined report file
```{r}

get_report_pid_df <- function(df, p_id){
  pid_df <- subset(df, df$participant_ID == p_id)
  pid_df <- subset(pid_df, pid_df$study_mode == "TIME")
  return(pid_df)
}

```

## Create a subset for the construct
uEMA combined file

```{r}

get_uEMA_pid_var_df <- function(df, variable){
  var_df <- subset(df, df$Q_ID == variable)
  return(var_df)
}

```

# Test code for a single participant

## get p-id subsets
First for the uEMA combined file

```{r}
participant_id = "neutergoldfishsworn@timestudy_com"

subset_pid_df <- get_uEMA_pid_df(combined_uema_file, participant_id) 
```

Then for the combined daily report file
```{r}

report_pid_df <- get_report_pid_df(combined_report_df, participant_id)

```

## add a waking period column to each response row
```{r}

for(i in 1:nrow(report_pid_df)){
  # print(paste0(i, " _ ", report_pid_df$current_wake_time[i]))
  subset_pid_df$wake_period[subset_pid_df$date_timestamp >= report_pid_df$current_wake_time[i] & subset_pid_df$date_timestamp <= report_pid_df$current_sleep_time[i]] <- paste0("Wake_period_", i)
}

```

## Remove CS microEMA
```{r}
subset_pid_df <- subset(subset_pid_df, subset_pid_df$Q_ID != "activity")
```


## Get a list of relevant construct/variable names
```{r}
var_list <- unique(subset_pid_df$Q_ID)
wake_period_list <- unique(subset_pid_df$wake_period)

```

## get p_id_subset
```{r}

prepare_pid_subset <- function(df, report_df, p_id) {
  pid_subset_df <- get_uEMA_pid_df(df, p_id)
  pid_report_df <- get_report_pid_df(report_df, p_id)
  pid_subset_df <- subset(pid_subset_df, pid_subset_df$Q_ID != "activity")
  
  for(i in 1:nrow(pid_report_df)){
  # print(paste0(i, " _ ", report_pid_df$current_wake_time[i]))
  pid_subset_df$wake_period[pid_subset_df$date_timestamp >= pid_report_df$current_wake_time[i] & pid_subset_df$date_timestamp <= pid_report_df$current_sleep_time[i]] <- paste0("Wake_period_", i)
  }
  
  return(pid_subset_df)
  
}

```



## Create a slope type function
```{r}

get_slope_type <- function(slist, vlist){
  slope_type = ""
  # print(slist)
  # print(vlist)
  # print(length(unique(vlist)))
  # print(unique(vlist))
  
  if (length(unique(vlist)) == 1){
    if (unique(vlist) == 3){
    slope_type = "Consistent-high"
    } else if (unique(vlist) == 2) {
    slope_type = "Consistent-medium"
    } else if (unique(vlist) == 1){
    slope_type = "Consistent-low"
    }
  } else {
    if (all(diff(slist) <= 0)) {
      slope_type = "Accumulation"
    } else if (all(diff(slist) >= 0)){
      # print("Satisfied")
      slope_type = "Dissipation"
    } else {
      slope_type = "Fluctuating"
    }
  }
  return(slope_type)
}

```

## Create function to get trajectory
```{r}

get_var_profile <- function(df, variable, wake_period_name){
  wake_subset_df <- subset(df, df$wake_period == wake_period_name & df$Q_ID == variable)
  # wake_subset_df <- subset(wake_subset_df, wake_subset_df$Q_ID == variable)
  # print(wake_subset_df)
  if (nrow(wake_subset_df) != 0){
    slope_list <- c()
    val_list = wake_subset_df$Answer_score
    # print(val_list)
    for (i in 1:nrow(wake_subset_df) - 1){
      del_y <- wake_subset_df$Answer_score[i + 1] - wake_subset_df$Answer_score[i]
      del_x <- as.numeric(difftime(wake_subset_df$date_timestamp[i + 1], wake_subset_df$date_timestamp[i], units = "hours"))
      slope <- del_y/del_x
      slope_list <- c(slope_list, slope)
    }
    profile_type <- get_slope_type(slope_list, val_list)
    return(profile_type)
  } else {
    return(NA)
  }
}

```

## Create funtion to get variance
```{r}

get_variance <- function(df, variable, wake_period_name){
  wake_subset_df <- subset(df, df$wake_period == wake_period_name & df$Q_ID == variable)
  # wake_subset_df <- subset(wake_subset_df, wake_subset_df$Q_ID == variable)
  # print(wake_subset_df)
  if (nrow(wake_subset_df) != 0){
    val_list = wake_subset_df$Answer_score
    # print(val_list)
    variance <- round(var(val_list), 2)
    return(variance)
  } else {
    return(NA)
  }
}

```


## Generate variance profile for each variable for p_id
```{r}

get_variance_df <- function(df, p_id){
  
  var_list_local <- unique(df$Q_ID)
  wake_period_list_local <- unique(df$wake_period)
  
  var_profile_df <- matrix(ncol = length(var_list_local) + 2, nrow = length(wake_period_list))

for (i in 1:length(wake_period_list_local)){
  
  var_profile_df[i, 1] <- p_id
  var_profile_df[i, 2] <- wake_period_list_local[[i]][1]
  for (j in 1:length(var_list_local)){
    var_profile_df[i, j + 2] <- get_variance(subset_pid_df, var_list_local[[j]][1], wake_period_list_local[[i]][1])
  }
  
}

var_profile_df <- as.data.frame(var_profile_df)
col_names <- c("p_id", "wake_period", var_list)

names(var_profile_df) <- col_names
return (var_profile_df)
}


```


## Generate temporal profile for each variable for p_id
```{r}

get_var_profile_df <- function(df, p_id){
  
  var_list_local <- unique(df$Q_ID)
  wake_period_list_local <- unique(df$wake_period)
  
  var_profile_df <- matrix(ncol = length(var_list_local) + 2, nrow = length(wake_period_list))

for (i in 1:length(wake_period_list_local)){
  
  var_profile_df[i, 1] <- p_id
  var_profile_df[i, 2] <- wake_period_list_local[[i]][1]
  for (j in 1:length(var_list_local)){
    var_profile_df[i, j + 2] <- get_var_profile(subset_pid_df, var_list_local[[j]][1], wake_period_list_local[[i]][1])
  }
  
}

var_profile_df <- as.data.frame(var_profile_df)
col_names <- c("p_id", "wake_period", var_list)

names(var_profile_df) <- col_names
return (var_profile_df)
}



```

## temporal profile distribution
```{r}

# ds1 <- data.frame(var1 = as.character(c("7","10","11","4", "7","10","11","4"))) 
# ds2 <- data.frame(var2 = c("4","4","7","7", "7","10","11","4"))
# 
# plot.df <- cbind(ds1, ds2)
get_profile_dist_plot <- function(df){
  temp_df <- df[, -c(1,2)]
plot.df <- reshape2::melt(temp_df, id.vars = NULL)
plot.df <- na.omit(plot.df)

dist_plot <- ggplot(plot.df) + geom_bar(aes(x = value)) + facet_wrap(~variable, ncol = 5) + theme(axis.text.x = element_text(angle = 90))
return(dist_plot)
}





```

## Get p_id_list
```{r}
p_id_list <- unique(combined_uema_file$Participant_ID)
```

## Test function to explore user data
```{r}

p_id <- "neutergoldfishsworn@timestudy_com"

pid_subset_df <- prepare_pid_subset(combined_uema_file, combined_report_df, p_id)

pid_var_profile_df <- get_var_profile_df(pid_subset_df, p_id)

pid_var_dist_plot <- get_profile_dist_plot(pid_var_profile_df)

## For varianc eonly
pid_variance_df <- get_variance_df(pid_subset_df, p_id)


```


## Set up a shiny app
```{r}

ui <- fluidPage(
  
  # Application title
  titlePanel("micro-EMA responses"),
  
  # Sidebar with dropdown
  fluidRow(column(4,
                  uiOutput("p_id")
  ),
    
  ),
  hr(),
   fluidRow(
        splitLayout(style = "border: 1px solid silver:", # cellWidths = c(300,300),
        plotOutput("plot_profile_dist", width = "500px", height = "1000px")
      )
   )
  )


server <- function(input, output) {
  
  output$p_id <- renderUI({
        selectInput("p_id", "Select a participant", choices = p_id_list)
    })
  
  user_subset_df <- reactive({
    prepare_pid_subset(combined_uema_file, input$p_id)
  })
  
  var_profile_df <- reactive({
    get_var_profile_df(user_subset_df(), input$p_id)
  })

  
  output$plot_profile_dist <- renderPlot({
    # get_acf_plot(combined_uema_file, input$p_id, input$variable)
    get_profile_dist_plot(var_profile_df())
  })
  

}

shinyApp(ui = ui, server = server)


```

