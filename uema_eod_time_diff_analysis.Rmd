---
title: "uema_eod_time_diff_analysis"
author: "Aditya Ponnada"
date: "6/4/2021"
output: html_document
---

## Import libraries
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(reshape2)
library(purrr)
```

## Read the uEMA combined responses + wake period mapped file
```{r}

uema_responses_path = "D:/uema_exploratory_plots/trajectory_plots/uema_wp_export.csv"

uema_wp_df <- read.csv(file=uema_responses_path, sep = ",", header = TRUE)


```

## Read the EOD file combined responses + wake period mapped
```{r}

eod_path <- "D:/uema_exploratory_plots/trajectory_plots/eod_wp_export.csv"

eod_df <- read.csv(file=eod_path, sep = ",", header = TRUE, row.names = NULL)


```

## Read the long format file for uema and eod
```{r}

long_merged_path = "D:/uema_exploratory_plots/trajectory_plots/merged_long_df.csv"

long_merged_df <- read.csv(file=long_merged_path, sep = ",", header = TRUE)

```

## Remove unkwon users
```{r}

eod_df <- subset(eod_df,eod_df$Participant_ID != "unknown_user")

uema_wp_df <- subset(uema_wp_df, uema_wp_df$Participant_ID != "unknown_user")

```

## Remove unwanted wake periods from the eod file
```{r}

wp_list <- unique(uema_wp_df$wake_period)

eod_df <- subset(eod_df, eod_df$wake_period %in% wp_list)

```


## Remove uncommon users
```{r}

uema_user_list <- unique(uema_wp_df$Participant_ID)

eod_df$P_ID <- paste0(eod_df$Participant_ID,  "@timestudy_com")

eod_df <- subset(eod_df, eod_df$P_ID %in% uema_user_list)

```

## Keep only relevant Q_IDs
```{r}

uema_qids <- c("control", "focus", "frust", "sad", "stress", "happy", "tense", "fatigue", "nervous", "relax")

uema_wp_df <- subset(uema_wp_df, uema_wp_df$Q_ID %in% uema_qids)

```

For EOD
```{r}

eod_qiods <- c("SAD", "HAPP", "FATIG", "REL", "TEN", "STRESS", "FRUST", "NERV", "RESIST", "FOC")

eod_df <- subset(eod_df, eod_df$Q_ID %in% eod_qiods)

```

Convert prompt time to date time objects
```{r}

uema_wp_df$date_timestamp <- as.POSIXct(uema_wp_df$date_timestamp, format = "%Y-%m-%d %H:%M:%OS")

```

for EOD
```{r}

eod_df$date_timestamp <- as.POSIXct(eod_df$Initial_Prompt_Local_Time, format="%Y-%m-%d %H:%M:%OS")

```

## Filter out the last uema prompt for each construct --  before EOD

```{r}

eod_df$p_id_wp <- paste0(eod_df$P_ID, "_", eod_df$wake_period)
uema_wp_df$p_id_wp <- paste0(uema_wp_df$Participant_ID, "_", uema_wp_df$wake_period)


```

Keep only the prompt time column and pid_wakeperiod column for each
```{r}

eod_df <- subset(eod_df, !is.na(eod_df$wake_period))

eod_wp_df <- eod_df[, c("p_id_wp", "date_timestamp")]

eod_wp_df <- unique(eod_wp_df)

```

Merge with uema_df
```{r}

uema_ts_wp_df <- uema_wp_df

joined_uema_eod_df <- merge(uema_ts_wp_df, eod_wp_df, by = "p_id_wp", all.x = FALSE, all.y = FALSE)

list_pid_wps <- unique(eod_wp_df$p_id_wp)


```

Loop through the eod_wp_df
```{r}

for (pid_wp in list_pid_wps){
  uema_ts_wp_df$eod_time[uema_ts_wp_df$p_id_wp == pid_wp] <- as.character(eod_wp_df$date_timestamp[eod_wp_df$p_id_wp == pid_wp])
}

uema_ts_wp_df$eod_time <- as.POSIXct(uema_ts_wp_df$eod_time, format = "%Y-%m-%d %H:%M:%OS")

```



