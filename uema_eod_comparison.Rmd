---
title: "uEMA vs EOD"
author: "Aditya Ponnada"
date: "5/31/2021"
output: html_document
---

## Import library
```{r}
library(ggplot2)
library(plotly)
library(psych)
library(rmcorr)
library(lme4)
library(dplyr)
```

## Read the uEMA file
```{r}

uema_path <- "D:/new_data_pre_processed/uema_trajectories_combined.csv"

uema_df <- read.csv(file=uema_path, sep = ",", header = TRUE)



```

## Read the eod file
```{r}

eod_path <- "D:/new_data_pre_processed/eod_trajectories_combined.csv"

eod_df <- read.csv(file=eod_path, sep = ",", header = TRUE)

```

## Keep only the common user names
```{r}

uema_pids <- unique(uema_df$p_id)

eod_df <- subset(eod_df, eod_df$p_id %in% uema_pids)

```

## Remove the "unknown user" account
```{r}

uema_df <- subset(uema_df, uema_df$p_id != "unknown_user")

```

## Rename the columns

Rename uema columns
```{r}

uema_names <- names(uema_df)

new_uema <- c()

for (name in uema_names){
  if (name != "p_id" && name != "wake_period"){
    name <- paste0("uema_", name)
  }
  new_uema <- c(new_uema, name)
}

names(uema_df) <- new_uema

```

Rename EMA columns
```{r}

eod_names <- names(eod_df)

new_eod <- c()

for (name in eod_names){
  name <- tolower(name)
  if (name != "p_id" && name != "wake_period"){
    name <- paste0("eod_", name)
  }
  new_eod <- c(new_eod, name)
}

names(eod_df) <- new_eod

```

## Merge the two dfs
merging by using p_id and wake period only
```{r}

merged_df <-merge(uema_df,eod_df,by=c("p_id","wake_period")) 

```


## test code to get frequency matrix plot between two columns
```{r}

ggplot(merged_df, aes(uema_nervous, ..count..)) + geom_bar(aes(fill = eod_nerv), position = "dodge")

```

Print table
```{r}
table(merged_df$uema_nervous, merged_df$eod_nerv)
```

Try heatmaps
```{r}
var_comp_df <- merged_df[, c("uema_stress", "eod_stress")]

count_df <- as.data.frame(table(var_comp_df))

ggplot(count_df, aes(x = eod_stress, y = uema_stress)) + geom_tile(aes(fill = Freq)) + scale_fill_gradient(name = 'Frequency', low = 'white', high = 'black') + theme(axis.title.y = element_blank())

```

## Create helper functions
get frequency table from main data frame

```{r}
get_ans_freq_table <- function(df, uema_var, ema_var){
  freq_table <- table(df[[ema_var]], df[[uema_var]])
  return(freq_table)
}
```

get the ema uema pair frequency data frame
```{r}

get_var_freq_plot <- function(df, uema_var, ema_var){
  var_only_subset_df <- df[, c(uema_var, ema_var)]
  var_pair_count_df <- as.data.frame(table(var_only_subset_df))
  g_plot <- ggplot(var_pair_count_df, aes_string(x = ema_var, y = uema_var)) + geom_tile(aes(fill = Freq)) + scale_fill_gradient(name = 'Frequency', low = 'white', high = 'black') + theme(axis.title.y = element_blank()) + ggtitle(paste0(uema_var, " and ", ema_var))
  return(g_plot)
}

```

get the ema uema pair frequency plot for the selected participant
```{r}

get_pid_var_freq_plot <- function(df, uema_var, ema_var, pid){
  p_id_subset <- subset(df, df$p_id == pid)
  pid_column_df <- p_id_subset[, c(uema_var,ema_var)]
  freq_df <- as.data.frame(table(pid_column_df))
  g_plot <- ggplot(freq_df, aes_string(x = ema_var, y = uema_var)) + geom_tile(aes(fill = Freq)) + scale_fill_gradient(name = 'Frequency', low = 'white', high = 'black') + theme(axis.title.y = element_blank()) + ggtitle(pid)
  return(g_plot)
  
}

```

get rows satisfying a criteria
```{r}

get_peak_effects_df <- function(df, uema_var, ema_var){
  var_df <- df[, c("p_id", "wake_period", uema_var, ema_var)]
  peak_effects_df <- subset(var_df, (var_df[[uema_var]] == "Accumulation" | var_df[[uema_var]] == "Fluctuating" | var_df[[uema_var]] == "Dissipation") & (var_df[[ema_var]] == "Extremely" | var_df[[ema_var]] == "Quite a bit"))
  return(peak_effects_df)
}

```

get number of rows for peak effects of each construct

```{r}
var_dict <- list(c("uema_stress", "eod_stress"), c("uema_nervous", "eod_nerv"), c("uema_tense", "eod_ten"), c("uema_happy", "eod_happ"), c("uema_fatigue", "eod_fatig"), c("uema_relax", "eod_rel"), c("uema_sad", "eod_sad"), c("uema_focus", "eod_foc"), c("uema_control", "eod_resist"))

```

Run a loop
```{r}

var_list <- c()
count_list <- c()
total_meas_list <- c()

for (vars in var_dict){
  # print(vars[[1]])
  temp_df <- get_peak_effects_df(merged_df, vars[[1]], vars[[2]])
  total_observation <- nrow(temp_df)
  var_name <- strsplit(vars[[1]], 'uema_')[[1]][2]
  # print(var_name)
  # var_name <- vars[[1]]
  var_search <- vars[[1]]
  total_uema_count <- length(na.omit(merged_df[[var_search]]))
  var_list <- c(var_list, var_name)
  count_list <- c(count_list, total_observation)
  total_meas_list <- c(total_meas_list, total_uema_count)
}

peak_effects_df <- data.frame(var_list, count_list, total_meas_list)

peak_effects_df$perc <- peak_effects_df$count_list/peak_effects_df$total_meas_list

```


## get peak effects summary table
```{r}
peak_effects_collection_df <- get_peak_effects_df(merged_df, "uema_stress", "eod_stress")

table(peak_effects_collection_df$uema_stress, peak_effects_collection_df$eod_stress)

```

## Convert to scores
```{r}
merged_copy_df <- merged_df

eod_mapping <- c("Extremely" = 5, "Very much so" = 5, "Quite a bit" = 4, "Moderately" = 3, "A little" = 2, "Not at all" = 1)
uema_mapping <- c("Consistent-high" = 6, "Accumulation" = 5, "Fluctuating" = 4, "Consistent-medium" = 3, "Dissipation" = 2, "Consistent-low" = 1)

for (vars in var_dict){
  uema_var <- vars[[1]]
  eod_var <- vars[[2]]
  
  merged_copy_df[[uema_var]] <- uema_mapping[merged_copy_df[[uema_var]]]
  merged_copy_df[[eod_var]] <- eod_mapping[merged_copy_df[[eod_var]]]
  
  
}

```

## try repeated measure correlations
Test code
```{r}

merged_copy_df$p_id <- as.factor(merged_copy_df$p_id)

merged_stress_df <- merged_copy_df[, c("p_id", "uema_stress", "eod_stress")]
merged_stress_df <- subset(merged_stress_df, !is.na(merged_stress_df$uema_stress))

rmcorr(participant = p_id, measure1 = uema_stress, measure2 = eod_stress, dataset = merged_stress_df)
```

